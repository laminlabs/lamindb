# Generated by Django 5.2.8 on 2025-11-23 10:55

import pgtrigger.compiler
import pgtrigger.migrations
from django.db import migrations


class Migration(migrations.Migration):
    dependencies = [
        ("lamindb", "0146_squashed"),
    ]

    operations = [
        pgtrigger.migrations.AddTrigger(
            model_name="record",
            trigger=pgtrigger.compiler.Trigger(
                name="update_feature_dtype_on_record_type_name_change",
                sql=pgtrigger.compiler.UpsertTriggerSql(
                    condition='WHEN (OLD."name" IS DISTINCT FROM (NEW."name") AND NEW."is_type")',
                    func="WITH RECURSIVE old_record_path AS (\n    SELECT\n        id,\n        name,\n        type_id,\n        name::TEXT AS path,\n        1 as depth\n    FROM lamindb_record\n    WHERE id = OLD.id\n\n    UNION ALL\n\n    SELECT\n        r.id,\n        r.name,\n        r.type_id,\n        r.name || '[' || rp.path AS path,\n        rp.depth + 1\n    FROM lamindb_record r\n    INNER JOIN old_record_path rp ON r.id = rp.type_id\n)\nUPDATE lamindb_feature\nSET dtype = REPLACE(\n    dtype, \n    (SELECT path FROM old_record_path ORDER BY depth DESC LIMIT 1),\n    REPLACE((SELECT path FROM old_record_path ORDER BY depth DESC LIMIT 1), OLD.name, NEW.name)\n)\nWHERE dtype LIKE '%cat[Record[%'\n  AND dtype LIKE '%' || (SELECT path FROM old_record_path ORDER BY depth DESC LIMIT 1) || '%';\n\nRETURN NEW;\n",
                    hash="b9e9a835bf928d5d4aa49d0cce862d946410e564",
                    operation="UPDATE",
                    pgid="pgtrigger_update_feature_dtype_on_record_type_name_change_28a83",
                    table="lamindb_record",
                    when="AFTER",
                ),
            ),
        ),
    ]
